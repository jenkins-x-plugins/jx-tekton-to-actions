jobs:
  release:
    steps:
    - name: next-version
      run: |-
        VERSION=$(jx-release-version)
        echo $VERSION > VERSION
      shell: bash
      uses: docker://gcr.io/jenkinsxio/jx-release-version:1.0.42
    - name: jx-variables
      run: jx gitops variables
      shell: sh
      uses: docker://gcr.io/jenkinsxio/jx-boot:3.1.28
    - name: build-make-build
      run: make build
      shell: sh
      uses: docker://gcr.io/jenkinsxio/builder-go:2.1.150-769
    - name: build-container-build
      run: |-
        source .jx/variables.sh
        cp /tekton/creds-secrets/tekton-container-registry-auth/.dockerconfigjson /kaniko/.docker/config.json
        /kaniko/executor $KANIKO_FLAGS --context=/workspace/source --dockerfile=/workspace/source/Dockerfile --destination=$DOCKER_REGISTRY/$DOCKER_REGISTRY_ORG/$APP_NAME:$VERSION
      shell: /busybox/sh
      uses: docker://gcr.io/kaniko-project/executor:debug-v1.3.0
    - name: promote-changelog
      run: |-
        source /workspace/source/.jx/variables.sh

        if [ -d "/workspace/source/charts/$REPO_NAME" ]; then
        sed -i -e "s/^version:.*/version: $VERSION/" ./charts/$REPO_NAME/Chart.yaml
        sed -i -e "s/repository:.*/repository: $DOCKER_REGISTRY\/$DOCKER_REGISTRY_ORG\/$APP_NAME/" ./charts/$REPO_NAME/values.yaml
        sed -i -e "s/tag:.*/tag: $VERSION/" ./charts/$REPO_NAME/values.yaml;
        else echo no charts; fi

        git commit -a -m "chore: release $VERSION" --allow-empty
        git tag -fa v$VERSION -m "Release version $VERSION"
        git push origin v$VERSION

        jx changelog create --version v${VERSION}
      shell: sh
      uses: docker://gcr.io/jenkinsxio/jx-changelog:0.0.13
    - name: promote-helm-release
      run: jx gitops helm release
      shell: sh
      uses: docker://gcr.io/jenkinsxio/jx-boot:3.1.28
    - name: promote-jx-promote
      run: |-
        source /workspace/source/.jx/variables.sh
        jx promote -b --all-auto --timeout 1h --no-poll
      shell: sh
      uses: docker://gcr.io/jenkinsxio/jx-promote:0.0.156
"on":
  push:
    branches:
    - main
    - master
